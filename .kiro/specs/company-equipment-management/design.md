# 設計ドキュメント

## 概要

会社の備品管理アプリケーションは、備品の登録、検索、貸出、返却、履歴管理を行う Web アプリケーションです。Next.js（App Router）と TypeScript を使用し、shadcn/ui コンポーネントライブラリで UI を構築します。データは JSON ファイルで永続化します。

システムは以下の主要機能を提供します：

- 備品の CRUD 操作（管理者のみ）
- 備品の検索とフィルタリング
- 備品の貸出・返却処理
- 貸出履歴の管理と表示
- ユーザーごとの借用状況確認

## アーキテクチャ

Next.js App Router を使用したフルスタックアーキテクチャを採用します：

```text
┌─────────────────────────────────────┐
│     プレゼンテーション層             │
│   (Next.js App Router + shadcn/ui)  │
│  - 備品一覧・詳細ページ              │
│  - 貸出・返却ページ                  │
│  - 管理ページ                        │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│      API Routes層                    │
│   (Next.js API Routes)              │
│  - /api/equipment                   │
│  - /api/loans                       │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│      ビジネスロジック層              │
│   (TypeScript Services)             │
│  - 備品管理サービス                  │
│  - 貸出管理サービス                  │
│  - バリデーションサービス            │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│      データアクセス層                │
│   (JSON File Storage)               │
│  - equipment.json                   │
│  - loans.json                       │
│  - users.json                       │
└─────────────────────────────────────┘
```

### 技術スタック

- フレームワーク: Next.js 16 (App Router), TypeScript
- UI: shadcn/ui (sonner 含む), Tailwind CSS
- アイコン: lucide-react
- 状態管理: TanStack Query (React Query)
- テーブル: TanStack Table
- フォーム: TanStack Form
- バリデーション: Valibot
- 日付処理: date-fns
- データストレージ: JSON ファイル
- ランタイム: Bun
- リンター/フォーマッター: Biome
- テスト: Bun Test (単体テスト), fast-check (Property-Based Testing), Playwright (E2E テスト)

## コンポーネントとインターフェース

### バックエンド API

#### 備品管理 API

```typescript
// 備品の取得
GET /api/equipment
GET /api/equipment/:id
GET /api/equipment?category=:category
GET /api/equipment?search=:keyword

// 備品の作成・更新・削除（管理者のみ）
POST /api/equipment
PUT /api/equipment/:id
DELETE /api/equipment/:id
```

#### 貸出管理 API

```typescript
// 貸出処理
POST /api/loans
  Body: { equipmentId: string, userId: string }

// 返却処理
PUT /api/loans/:id/return

// 貸出履歴の取得
GET /api/loans
GET /api/loans?equipmentId=:id
GET /api/loans?userId=:id
GET /api/loans/my-loans
```

### フロントエンドコンポーネント

- `EquipmentList`: 備品一覧表示（TanStack Table + shadcn/ui）
- `EquipmentDetail`: 備品詳細表示（shadcn/ui Card）
- `EquipmentForm`: 備品登録・編集フォーム（TanStack Form + Valibot + shadcn/ui）
- `LoanButton`: 貸出ボタン（shadcn/ui Button）
- `ReturnButton`: 返却ボタン（shadcn/ui Button）
- `LoanHistory`: 貸出履歴表示（TanStack Table + shadcn/ui）
- `MyLoans`: 自分の借用状況表示（shadcn/ui Card）
- `SearchBar`: 検索バー（shadcn/ui Input）
- `CategoryFilter`: カテゴリフィルター（shadcn/ui Select）

## データモデル

### Equipment（備品）

```typescript
interface Equipment {
  id: string; // 一意のID（UUID）
  name: string; // 備品名（必須）
  category: string; // カテゴリ（必須）
  description: string; // 説明
  totalQuantity: number; // 総数量
  availableQuantity: number; // 利用可能数量
  purchaseDate: Date; // 購入日（必須）
  usefulLife: number; // 耐用年数（年単位、オプション）
  createdAt: Date; // 登録日時
  updatedAt: Date; // 更新日時
}
```

### Loan（貸出記録）

```typescript
interface Loan {
  id: string; // 一意のID（UUID）
  equipmentId: string; // 備品ID
  userId: string; // ユーザーID
  borrowedAt: Date; // 貸出日時
  returnedAt: Date | null; // 返却日時（未返却の場合null）
  status: 'active' | 'returned'; // ステータス
}
```

### User（ユーザー）

```typescript
interface User {
  id: string; // 一意のID（UUID）
  name: string; // ユーザー名
  email: string; // メールアドレス
  role: 'user' | 'admin'; // 役割
}
```

### バリデーションスキーマ（Valibot）

```typescript
import * as v from 'valibot';

// 備品バリデーションスキーマ
const EquipmentSchema = v.object({
  name: v.pipe(
    v.string(),
    v.trim(),
    v.minLength(1, '備品名は必須です'),
    v.maxLength(100, '備品名は100文字以内である必要があります')
  ),
  category: v.pipe(
    v.string(),
    v.trim(),
    v.minLength(1, 'カテゴリは必須です'),
    v.maxLength(50, 'カテゴリは50文字以内である必要があります')
  ),
  description: v.pipe(
    v.string(),
    v.maxLength(500, '説明は500文字以内である必要があります')
  ),
  totalQuantity: v.pipe(
    v.number(),
    v.integer('数量は整数である必要があります'),
    v.minValue(0, '数量は0以上である必要があります'),
    v.maxValue(10000, '数量は10000以下である必要があります')
  ),
  purchaseDate: v.pipe(
    v.date(),
    v.maxValue(new Date(), '購入日は未来の日付にできません')
  ),
  usefulLife: v.optional(
    v.pipe(
      v.number(),
      v.integer('耐用年数は整数である必要があります'),
      v.minValue(1, '耐用年数は1年以上である必要があります'),
      v.maxValue(100, '耐用年数は100年以下である必要があります')
    )
  ),
});

// 貸出バリデーションスキーマ
const LoanSchema = v.object({
  equipmentId: v.pipe(v.string(), v.uuid('有効な備品IDが必要です')),
  userId: v.pipe(v.string(), v.uuid('有効なユーザーIDが必要です')),
});
```

## 正確性プロパティ

_プロパティとは、システムのすべての有効な実行において真であるべき特性または動作です。本質的には、システムが何をすべきかについての形式的な記述です。プロパティは、人間が読める仕様と機械で検証可能な正確性保証との橋渡しとなります。_

### プロパティ 1: 備品登録の完全性

*任意の*有効な備品データ（備品名、カテゴリ、数量、説明）に対して、登録処理を実行すると、新しい備品レコードが作成され、一意の ID が割り当てられ、登録日時が記録される
**検証: 要件 1.1, 1.3**

### プロパティ 2: 必須フィールドバリデーション

*任意の*備品データで、備品名またはカテゴリが空文字列または空白文字のみの場合、登録処理は拒否され、エラーメッセージが返される
**検証: 要件 1.2**

### プロパティ 3: 備品登録のラウンドトリップ

*任意の*有効な備品データに対して、登録してから同じ ID で取得すると、同等のデータが返される
**検証: 要件 1.4**

### プロパティ 4: カテゴリフィルタリングの正確性

*任意の*備品セットとカテゴリに対して、カテゴリでフィルタリングした結果は、すべて指定されたカテゴリに属する備品のみを含む
**検証: 要件 2.2**

### プロパティ 5: 検索結果の一致性

*任意の*備品セットと検索キーワードに対して、検索結果のすべての備品名は、そのキーワードを含む
**検証: 要件 2.3**

### プロパティ 6: 備品詳細の完全性

*任意の*備品に対して、詳細表示結果は、備品名、カテゴリ、説明、在庫数、貸出状況のすべてのフィールドを含む
**検証: 要件 2.4**

### プロパティ 7: 貸出時の在庫減少

*任意の*利用可能な備品（availableQuantity > 0）に対して、貸出処理を実行すると、在庫数が 1 減少し、新しい貸出記録が作成される
**検証: 要件 3.1**

### プロパティ 8: 貸出記録の完全性

*任意の*貸出処理に対して、作成される貸出記録は、ユーザー ID、備品 ID、貸出日時のすべてのフィールドを含む
**検証: 要件 3.3**

### プロパティ 9: 返却時の在庫増加

*任意の*貸出中の備品に対して、返却処理を実行すると、在庫数が 1 増加し、貸出記録のステータスが'returned'に更新され、返却日時が記録される
**検証: 要件 4.1, 4.2**

### プロパティ 10: 無効な返却の拒否

*任意の*ユーザーと備品の組み合わせで、そのユーザーが現在借りていない備品の返却を試みると、処理は拒否され、エラーメッセージが返される
**検証: 要件 4.3**

### プロパティ 11: 備品更新の永続化

*任意の*既存の備品と更新データに対して、更新処理を実行してから取得すると、更新されたデータが返され、updatedAt フィールドが更新される
**検証: 要件 5.1**

### プロパティ 12: 貸出中備品の削除制約

*任意の*貸出中の備品（status='active'の貸出記録が存在）に対して、削除処理を試みると、処理は拒否され、警告メッセージが返される
**検証: 要件 5.2**

### プロパティ 13: 備品削除の完全性

*任意の*貸出されていない備品に対して、削除処理を実行してから取得を試みると、備品が見つからないエラーが返される
**検証: 要件 5.3**

### プロパティ 14: 備品別履歴フィルタリング

*任意の*貸出記録セットと備品 ID に対して、その備品の履歴を取得すると、すべての結果が指定された備品 ID を持ち、時系列順（降順）にソートされている
**検証: 要件 6.2**

### プロパティ 15: ユーザー別履歴フィルタリング

*任意の*貸出記録セットとユーザー ID に対して、そのユーザーの履歴を取得すると、すべての結果が指定されたユーザー ID を持ち、時系列順（降順）にソートされている
**検証: 要件 6.3**

### プロパティ 16: 貸出記録表示の完全性

*任意の*貸出記録に対して、表示結果は、備品名、ユーザー名、貸出日時、返却日時、ステータスのすべてのフィールドを含む
**検証: 要件 6.4**

### プロパティ 17: 現在の借用リストの正確性

*任意の*ユーザーに対して、現在の借用リストを取得すると、すべての結果がそのユーザー ID を持ち、status='active'である
**検証: 要件 7.1**

### プロパティ 18: 借用リスト表示の完全性

*任意の*借用リストに対して、各項目の表示結果は、備品名、カテゴリ、貸出日のすべてのフィールドを含む
**検証: 要件 7.3**

## エラーハンドリング

### エラーの種類

1. **バリデーションエラー**: 入力データが要件を満たさない場合

   - 必須フィールドの欠落
   - 無効なデータ形式
   - HTTP ステータス: 400 Bad Request

2. **認可エラー**: ユーザーが操作権限を持たない場合

   - 管理者専用操作への一般ユーザーのアクセス
   - HTTP ステータス: 403 Forbidden

3. **リソース不足エラー**: 要求されたリソースが利用できない場合

   - 在庫切れの備品の貸出試行
   - HTTP ステータス: 409 Conflict

4. **ビジネスルール違反エラー**: ビジネスロジックの制約違反

   - 貸出中の備品の削除試行
   - 借りていない備品の返却試行
   - HTTP ステータス: 422 Unprocessable Entity

5. **リソース未検出エラー**: 要求されたリソースが存在しない場合
   - 存在しない備品 ID での操作
   - HTTP ステータス: 404 Not Found

### エラーレスポンス形式

```typescript
interface ErrorResponse {
  error: {
    code: string; // エラーコード
    message: string; // ユーザー向けメッセージ
    details?: any; // 追加の詳細情報
  };
}
```

### エラーハンドリング戦略

- すべての API 呼び出しは try-catch ブロックで保護
- JSON ファイル操作は排他制御を実装し、データ整合性を保証
- フロントエンドでは shadcn/ui の Toast コンポーネントでエラーメッセージを表示
- すべてのエラーはコンソールに記録

## テスト戦略

### ユニットテスト（Bun Test）

ユニットテストは以下をカバーします：

- 個別の関数とメソッドの動作確認
- エッジケースの検証（空の入力、境界値など）
- エラー条件の確認
- ビジネスロジックの検証

主要なテスト対象：

- バリデーション関数
- ビジネスロジック関数（サービス層）
- データアクセス関数（JSON 読み書き）
- ユーティリティ関数

**使用ライブラリ**: Bun Test

**テスト配置**: `__tests__` ディレクトリまたは `.test.ts` ファイル

### プロパティベーステスト（Bun Test + fast-check）

プロパティベーステストは、上記の正確性プロパティを検証します。

**使用ライブラリ**: fast-check（TypeScript/JavaScript 用のプロパティベーステストライブラリ）+ Bun Test

**テスト設定**:

- 各プロパティテストは最低 100 回の反復を実行
- ランダムなテストデータを生成して、プロパティが常に成立することを確認

**タグ付け規則**:

- 各プロパティベーステストには、対応する正確性プロパティを参照するコメントを付ける
- 形式: `// Feature: company-equipment-management, Property X: [プロパティ名]`

**テストの配置**:

- プロパティテストは実装の直後に配置し、早期にエラーを検出
- 各正確性プロパティは 1 つのプロパティベーステストで実装

**ジェネレータ戦略**:

- 有効な備品データのジェネレータ
- 無効な備品データのジェネレータ（バリデーションテスト用）
- ユーザーデータのジェネレータ
- 貸出記録のジェネレータ
- エッジケース（在庫 0、空のリストなど）を含むジェネレータ

### E2E テスト（Playwright）

E2E テストは以下をカバーします：

- ユーザーの実際の操作フロー
- ページ間の遷移
- UI コンポーネントの統合
- エンドツーエンドのビジネスシナリオ

主要なテストシナリオ：

- 備品の登録から検索、貸出、返却までの一連の流れ
- 管理者による備品管理操作
- エラーケースの UI 表示

**使用ライブラリ**: Playwright

**テスト配置**: `e2e` ディレクトリ

### テストデータ管理

- テストごとにクリーンな JSON ファイル状態を確保
- テストフィクスチャを使用して一貫したテストデータを提供
- テスト後のクリーンアップを自動化
- E2E テストでは専用のテストデータセットを使用
