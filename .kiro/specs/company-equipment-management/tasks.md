# 実装計画

- [x] 1. プロジェクトのセットアップと基本構成

  - Next.js 16 プロジェクトを Bun で初期化
  - 必要な依存関係をインストール（shadcn/ui、TanStack Query、TanStack Table、TanStack Form、Valibot、date-fns、lucide-react）
  - Biome の設定ファイルを作成
  - TypeScript の設定を最適化
  - _要件: すべて_

- [x] 2. データモデルとバリデーションスキーマの実装

  - [x] 2.1 TypeScript 型定義を作成

    - Equipment、Loan、User インターフェースを定義
    - _要件: 1.1, 3.3, 4.2_

  - [x] 2.2 Valibot バリデーションスキーマを実装

    - EquipmentSchema と LoanSchema を作成
    - バリデーションルールを実装（文字数制限、数値範囲、日付検証）
    - _要件: 1.2, 1.5_

  - [x] 2.3 プロパティテスト: 必須フィールドバリデーション [PBT:passed]

    - **プロパティ 2: 必須フィールドバリデーション**
    - **検証: 要件 1.2**

- [ ] 3. JSON ストレージ層の実装

  - [x] 3.1 JSON ファイル読み書きユーティリティを作成

    - ファイルロック機構を実装してデータ整合性を保証
    - エラーハンドリングを実装
    - _要件: 1.4_

  - [x] 3.2 データアクセス関数を実装

    - 備品の CRUD 操作関数
    - 貸出記録の CRUD 操作関数
    - ユーザーの読み取り操作関数
    - _要件: 1.1, 1.4, 3.1, 4.1, 5.1, 5.3_

  - [x] 3.3 プロパティテスト: 備品登録のラウンドトリップ [PBT:passed]

    - **プロパティ 3: 備品登録のラウンドトリップ**
    - **検証: 要件 1.4**

- [x] 4. ビジネスロジック層の実装

  - [x] 4.1 備品管理サービスを実装

    - 備品の作成、更新、削除ロジック
    - 在庫数の計算ロジック
    - 貸出中備品の削除制約チェック
    - _要件: 1.1, 5.1, 5.2, 5.3_

  - [x] 4.2 貸出管理サービスを実装

    - 貸出処理ロジック（在庫減少）
    - 返却処理ロジック（在庫増加）
    - 貸出可能性チェック
    - _要件: 3.1, 3.2, 4.1, 4.3_

  - [x] 4.3 プロパティテスト: 備品登録の完全性 [PBT:passed]

    - **プロパティ 1: 備品登録の完全性**
    - **検証: 要件 1.1, 1.3**

  - [x] 4.4 プロパティテスト: 貸出時の在庫減少 [PBT:passed]

    - **プロパティ 7: 貸出時の在庫減少**
    - **検証: 要件 3.1**

  - [x] 4.5 プロパティテスト: 返却時の在庫増加 [PBT:passed]

    - **プロパティ 9: 返却時の在庫増加**
    - **検証: 要件 4.1, 4.2**

  - [x] 4.6 プロパティテスト: 貸出中備品の削除制約 [PBT:passed]

    - **プロパティ 12: 貸出中備品の削除制約**
    - **検証: 要件 5.2**

- [x] 5. API Routes の実装

  - [x] 5.1 備品管理 API を実装

    - GET /api/equipment（一覧取得、検索、フィルタリング）
    - GET /api/equipment/[id]（詳細取得）
    - POST /api/equipment（作成）
    - PUT /api/equipment/[id]（更新）
    - DELETE /api/equipment/[id]（削除）
    - _要件: 1.1, 2.1, 2.2, 2.3, 2.4, 5.1, 5.3_

  - [x] 5.2 貸出管理 API を実装

    - POST /api/loans（貸出処理）
    - PUT /api/loans/[id]/return（返却処理）
    - GET /api/loans（履歴取得、フィルタリング）
    - GET /api/loans/my-loans（自分の借用状況）
    - _要件: 3.1, 4.1, 6.1, 6.2, 6.3, 7.1_

  - [x] 5.3 プロパティテスト: カテゴリフィルタリングの正確性 [PBT:passed]

    - **プロパティ 4: カテゴリフィルタリングの正確性**
    - **検証: 要件 2.2**

  - [x] 5.4 プロパティテスト: 検索結果の一致性 [PBT:passed]

    - **プロパティ 5: 検索結果の一致性**
    - **検証: 要件 2.3**
    - **Note**: Test uses a limited character set (alphanumeric + basic Japanese hiragana/katakana) due to JSON Server's regex-based matching limitations

  - [x] 5.5 プロパティテスト: 無効な返却の拒否 [PBT:passed]

    - **プロパティ 10: 無効な返却の拒否**
    - **検証: 要件 4.3**

- [x] 6. チェックポイント - すべてのテストが通ることを確認

  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

-

- [x] 7. shadcn/ui コンポーネントのセットアップ

  - shadcn/ui を初期化
  - 必要なコンポーネントをインストール（Button、Input、Table、Card、Select、Form、Toast）
  - TanStack Query の Provider を設定
  - _要件: すべて_

- [ ] 8. 備品一覧ページの実装

  - [x] 8.1 備品一覧ページを作成（/equipment）

    - TanStack Table で備品一覧を表示
    - 検索バーとカテゴリフィルターを実装
    - TanStack Query でデータフェッチ
    - _要件: 2.1, 2.2, 2.3_

  - [x] 8.2 プロパティテスト: 備品詳細の完全性 [PBT:passed]

    - **プロパティ 6: 備品詳細の完全性**
    - **検証: 要件 2.4**

- [x] 9. 備品詳細・登録・編集ページの実装

  - [x] 9.1 備品詳細ページを作成（/equipment/[id]）

    - 備品情報を Card で表示
    - 貸出ボタンを実装
    - _要件: 2.4_

  - [x] 9.2 備品登録・編集フォームを実装

    - TanStack Form + Valibot でフォームを作成
    - 日付ピッカーを date-fns で実装
    - エラーメッセージ表示
    - _要件: 1.1, 1.2, 1.5, 5.1_

  - [x] 9.3 プロパティテスト: 備品更新の永続化 [PBT:passed]

    - **プロパティ 11: 備品更新の永続化**
    - **検証: 要件 5.1**

- [x] 10. 貸出・返却機能の実装

  - [x] 10.1 貸出処理を実装

    - 貸出ボタンのクリックハンドラ
    - 在庫チェックとエラーハンドリング
    - 楽観的更新（TanStack Query）
    - _要件: 3.1, 3.2_

  - [x] 10.2 返却処理を実装

    - 返却ボタンのクリックハンドラ
    - エラーハンドリング
    - 楽観的更新
    - _要件: 4.1, 4.3_

  - [x] 10.3 プロパティテスト: 貸出記録の完全性 [PBT:passed]

    - **プロパティ 8: 貸出記録の完全性**
    - **検証: 要件 3.3**

  - [x] 10.4 プロパティテスト: 備品削除の完全性 [PBT:passed]

    - **プロパティ 13: 備品削除の完全性**
    - **検証: 要件 5.3**

- [-] 11. 貸出履歴ページの実装

  - [x] 11.1 貸出履歴ページを作成（/loans）

    - TanStack Table で履歴を表示
    - 備品別・ユーザー別フィルタリング
    - 日付フォーマット（date-fns）
    - _要件: 6.1, 6.2, 6.3, 6.4_

- - [x] 11.2 プロパティテスト: 備品別履歴フィルタリング [PBT:passed]

    - **プロパティ 14: 備品別履歴フィルタリング**
    - **検証: 要件 6.2**

  - [x] 11.3 プロパティテスト: ユーザー別履歴フィルタリング [PBT:passed]

    - **プロパティ 15: ユーザー別履歴フィルタリング**
    - **検証: 要件 6.3**

  - [x] 11.4 プロパティテスト: 貸出記録表示の完全性 [PBT:passed]

    - **プロパティ 16: 貸出記録表示の完全性**
    - **検証: 要件 6.4**

- [-] 12. マイページの実装

  - [x] 12.1 マイページを作成（/my-loans）

    - 現在借りている備品のリストを表示
    - 返却ボタンを各項目に配置
    - 空状態のメッセージ表示
    - _要件: 7.1, 7.2, 7.3_

  - [x] 12.2 プロパティテスト: 現在の借用リストの正確性 [PBT:passed]

    - **プロパティ 17: 現在の借用リストの正確性**
    - **検証: 要件 7.1**

  - [x] 12.3 プロパティテスト: 借用リスト表示の完全性 [PBT:passed]

    - **プロパティ 18: 借用リスト表示の完全性**
    - **検証: 要件 7.3**

- [x] 13. エラーハンドリングとトースト通知の実装

  - すべての API 呼び出しにエラーハンドリングを追加
  - sonner でトースト通知を実装
  - エラーメッセージの表示
  - 成功メッセージの表示
  - _要件: すべて_

-

- [x] 14. チェックポイント - すべてのテストが通ることを確認

  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 15. E2E テストの実装

  - [x] 15.1 Playwright のセットアップ

    - Playwright をインストールして設定

  - [x] 15.2 備品管理フローの E2E テスト

    - 備品登録から検索、貸出、返却までの一連の流れをテスト

  - [x] 15.3 エラーケースの E2E テスト

    - バリデーションエラー、在庫切れ、権限エラーなどをテスト

- [ ] 16. 最終チェックポイント

  - すべてのテストが通ることを確認し、問題があればユーザーに質問する
